name: Update Google Merchant Feed

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install googleapis
        run: npm install googleapis
      
      - name: Debug - Check Secrets
        env:
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          MERCHANT_ID: ${{ secrets.MERCHANT_ID }}
        run: |
          echo "=== DEBUG INFO ==="
          echo "CLIENT_EMAIL exists: $([[ -n "$GOOGLE_CLIENT_EMAIL" ]] && echo 'YES' || echo 'NO')"
          echo "CLIENT_EMAIL length: ${#GOOGLE_CLIENT_EMAIL}"
          echo "CLIENT_EMAIL first 30 chars: ${GOOGLE_CLIENT_EMAIL:0:30}..."
          echo ""
          echo "PRIVATE_KEY exists: $([[ -n "$GOOGLE_PRIVATE_KEY" ]] && echo 'YES' || echo 'NO')"
          echo "PRIVATE_KEY length: ${#GOOGLE_PRIVATE_KEY}"
          echo "PRIVATE_KEY starts with: ${GOOGLE_PRIVATE_KEY:0:30}..."
          echo "PRIVATE_KEY ends with: ...${GOOGLE_PRIVATE_KEY: -30}"
          echo ""
          echo "MERCHANT_ID exists: $([[ -n "$MERCHANT_ID" ]] && echo 'YES' || echo 'NO')"
          echo "MERCHANT_ID value: $MERCHANT_ID"
          echo "=================="
      
      - name: Trigger Feed Fetch
        env:
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          MERCHANT_ID: ${{ secrets.MERCHANT_ID }}
        run: |
          cat > fetch-feed.js << 'EOF'
          const { google } = require('googleapis');
          
          async function fetchFeed() {
            try {
              console.log('ðŸ”„ Starting feed fetch process...');
              
              const clientEmail = process.env.GOOGLE_CLIENT_EMAIL;
              const privateKey = process.env.GOOGLE_PRIVATE_KEY;
              const merchantId = process.env.MERCHANT_ID;
              
              console.log('\n=== Environment Check ===');
              console.log('CLIENT_EMAIL:', clientEmail ? 'EXISTS (length: ' + clientEmail.length + ')' : 'âŒ MISSING');
              console.log('PRIVATE_KEY:', privateKey ? 'EXISTS (length: ' + privateKey.length + ')' : 'âŒ MISSING');
              console.log('MERCHANT_ID:', merchantId || 'âŒ MISSING');
              
              if (!clientEmail) throw new Error('GOOGLE_CLIENT_EMAIL is missing');
              if (!privateKey) throw new Error('GOOGLE_PRIVATE_KEY is missing');
              if (!merchantId) throw new Error('MERCHANT_ID is missing');
              
              console.log('\n=== Private Key Format Check ===');
              console.log('Starts with BEGIN:', privateKey.startsWith('-----BEGIN'));
              console.log('Ends with END:', privateKey.includes('-----END'));
              console.log('Contains \\n:', privateKey.includes('\\n'));
              console.log('First 50 chars:', privateKey.substring(0, 50));
              
              // Try to format the key
              let formattedKey = privateKey;
              if (privateKey.includes('\\n')) {
                console.log('Converting \\n to newlines...');
                formattedKey = privateKey.replace(/\\n/g, '\n');
              }
              
              console.log('\n=== Creating JWT Auth ===');
              const auth = new google.auth.JWT(
                clientEmail,
                null,
                formattedKey,
                ['https://www.googleapis.com/auth/content']
              );
              
              console.log('ðŸ”“ Attempting authorization...');
              await auth.authorize();
              console.log('âœ… Authorization successful!');
              
              const content = google.content({ version: 'v2.1', auth });
              
              console.log(`\nðŸ“‹ Fetching feeds for Merchant ID: ${merchantId}`);
              
              const feeds = await content.datafeeds.list({ merchantId });
              
              if (!feeds.data.resources || feeds.data.resources.length === 0) {
                console.log('âŒ No feeds found');
                return;
              }
              
              console.log(`âœ… Found ${feeds.data.resources.length} feed(s)`);
              
              for (const feed of feeds.data.resources) {
                console.log(`\nðŸ”„ Fetching feed: ${feed.name} (ID: ${feed.id})`);
                await content.datafeeds.fetchnow({
                  merchantId: merchantId,
                  datafeedId: feed.id.toString()
                });
                console.log(`âœ… Successfully fetched: ${feed.name}`);
              }
              
              console.log('\nðŸŽ‰ All feeds updated successfully!');
            } catch (error) {
              console.error('\nâŒ ERROR OCCURRED:');
              console.error('Message:', error.message);
              if (error.code) console.error('Code:', error.code);
              if (error.response?.data) {
                console.error('Response:', JSON.stringify(error.response.data, null, 2));
              }
              if (error.stack) console.error('Stack:', error.stack);
              process.exit(1);
            }
          }
          
          fetchFeed();
          EOF
          
          node fetch-feed.js
