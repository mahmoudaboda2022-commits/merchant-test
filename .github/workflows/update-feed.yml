name: Update Google Merchant Feed

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install googleapis
        run: npm install googleapis
      
      - name: Trigger Feed Fetch
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          MERCHANT_ID: ${{ secrets.MERCHANT_ID }}
        run: |
          cat > fetch-feed.js << 'EOF'
          const { google } = require('googleapis');
          
          async function fetchFeed() {
            try {
              console.log('ðŸ”„ Starting feed fetch process...');
              
              const serviceAccountBase64 = process.env.GOOGLE_SERVICE_ACCOUNT_JSON;
              const merchantId = process.env.MERCHANT_ID;
              
              if (!serviceAccountBase64 || !merchantId) {
                throw new Error('Missing required environment variables');
              }
              
              console.log('ðŸ”“ Decoding service account JSON from base64...');
              const serviceAccountJson = Buffer.from(serviceAccountBase64, 'base64').toString('utf-8');
              const credentials = JSON.parse(serviceAccountJson);
              
              console.log('âœ… Service account decoded successfully');
              console.log('ðŸ“§ Client Email:', credentials.client_email);
              console.log('ðŸª Merchant ID:', merchantId);
              
              console.log('\nðŸ” Creating JWT auth from credentials...');
              const auth = new google.auth.JWT({
                email: credentials.client_email,
                key: credentials.private_key,
                scopes: ['https://www.googleapis.com/auth/content']
              });
              
              console.log('ðŸ”“ Attempting authorization...');
              await auth.authorize();
              console.log('âœ… Authorization successful!');
              
              const content = google.content({ version: 'v2.1', auth });
              
              console.log(`\nðŸ“‹ Fetching feeds for Merchant ID: ${merchantId}`);
              
              const feeds = await content.datafeeds.list({ merchantId });
              
              if (!feeds.data.resources || feeds.data.resources.length === 0) {
                console.log('âŒ No feeds found');
                return;
              }
              
              console.log(`âœ… Found ${feeds.data.resources.length} feed(s)`);
              
              for (const feed of feeds.data.resources) {
                console.log(`\nðŸ”„ Fetching feed: ${feed.name} (ID: ${feed.id})`);
                await content.datafeeds.fetchnow({
                  merchantId: merchantId,
                  datafeedId: feed.id.toString()
                });
                console.log(`âœ… Successfully fetched: ${feed.name}`);
              }
              
              console.log('\nðŸŽ‰ All feeds updated successfully!');
            } catch (error) {
              console.error('\nâŒ ERROR OCCURRED:');
              console.error('Message:', error.message);
              if (error.code) console.error('Code:', error.code);
              if (error.response?.data) {
                console.error('Response:', JSON.stringify(error.response.data, null, 2));
              }
              process.exit(1);
            }
          }
          
          fetchFeed();
          EOF
          
          node fetch-feed.js
